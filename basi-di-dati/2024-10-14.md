#basi-di-dati 
# SQL - Operatori aggregativi
## Tabelle di riferimento:
- **STUDENTI** (Matr, Nome, Cognome, CF)
- **ESAMI** (Matr_Stud, Cod_Corso, Voto, Data)
### Q1: Raggruppare gli studenti e contare il numero di esami che ciascuno ha passato e la media
 ![[tabelle-studenti-esami.svg]]
![[tabella-stud-fatt-Q1.svg#invert_B]]
```sql
SELECT S.NOME, S.COGNOME, COUNT(COD_CORSO) AS N_ESAMI,AVG(E.VOTO) AS V_MED
FROM STUDENTI S, ESAMI E
WHERE S.MATR = E.MATR_STUD
AND E.VOTO > 17
GROUP BY S.MATR;
```
### Q2: Media del voto e numero degli esami con esito positivo
```sql
SELECT COUNT(*) AS N_ESAMI, AVG(E.VOTO) AS MEDIA
FROM ESAMI E 
WHERE E.VOTO > 17;
```
### Q3: Numero degli esami con esito negativo
```sql
SELECT COUNT(*) 
FROM ESAMI E
WHERE E.VOTO = 17
```


## Tabelle di riferimento:
- FATTURE (**ID**, NUM, P_IVA_FORN)
- RIGHE (**ID_FATT**, **POS**, COD_ART, PERC_IVA, P_UNIT, QUANT)

![[fattura-riga-ER.svg#invert_B]]
Esempio della tabella fatture:
![[tabella-fatture.svg#invert_B]] 
### Q1) Per ogni FORN(P_IVA_FORN) e DATA specificare il numero di fatture.
![[tabella-fatt-riga-Q1.svg#invert_B]]
```sql
SELECT F.P_IVA_FORN, F.DATA, COUNT(*) AS NUM_FATT
FROM FATTURE F
GROUP BY F.P_IVA_FORN, F.DATA;
```
### Q2) Per ogni fattura, calcolare: TOT, IVA, TOT_IVATO
```sql
SELECT  R.*, 
		R.P_UNIT * R.QUANT AS TOT,
		TOT * R.PERC_IVA / 100 AS IVA,
		TOT + IVA AS TOT_IVATO
FROM RIGHE R;
```
### Q3) Quante sono le fatture? 
```sql
SELECT COUNT(*) 
FROM FATTURE F;
```


## Tabella di riferimento:
- **STUDENTI** (*MATR*, NOME, COGNOME, CF)
- **ESAMI** (*MATR_STUD, COD_CORSO*, VOTO, DATA)
- **CORSI** (*CODICE*, DENOM, CFU, DOCENTE)
### Q1: Studenti che hanno preso la lode (31) in 'Basi Di Dati'
```sql
SELECT S.*
FROM STUDENTI S, ESAMI E, CORSI C
WHERE S.MATR = E.MATR_STUD
	AND E.COD_CORSO = C.CODICE
	AND C.DENOM = 'BASI DI DATI'
	AND E.VOTO = 31;
```
### Q2: Studenti che hanno preso piu di PAPERONE PAPERIS in "Linguaggi per il Web"

![[schema-stud-corsi-Q2.svg#invert_B]]

```sql
SELECT S.*
FROM STUDENTI SPP, STUDENTI S, ESAMI EPP, ESAMI E, CORSI C
WHERE SPP.NOME = 'PAPERONE'
	AND SPP.COGNOME = 'PAPERIS'
	AND EPP.COD_CORSO = C.CODICE
	AND SPP.MATR = EPP.MATR_STUD
	AND C.DENOM = 'LINGUAGGI PER IL WEB'
	AND E.COD_CORSO = C.CODICE
	AND S.MATR = E.MATR_STUD
	AND E.VOTO > EPP.VOTO
```

### Q3: Per ogni corso indicare il numero di esami sostenuti con esito positivo e media, ordinate per num esami decrescente
```sql
SELECT C.denominaz,
	COUNT(*) AS Num_Esami,
	AVG(voto) AS Media_Voti
FROM Corsi C, Esami E
WHERE C.codice = E.cod_corso
	AND E.voto > 17
GROUP BY C.codice
ORDER BY Num_Esami DESC, C.denominaz;
```

# Inserimento in tabella INSERT INTO
## Sintassi di base
```sql
INSERT INTO <nome-tab> VALUES (<val1>, ..., <val-k>);
```

>[!example]
>```sql 
>INSERT INTO STUDENTI VALUES (12345, 'Mario', 'Rossi', 'MRORSS90A01H501Z');
>```

>[!Example] Example (Specificando le colonne)
>```sql
>INSERT INTO STUDENTI (MATR, NOME, COGNOME) 
>VALUES (12347, 'Giulia', 'Verdi'), 
> 	(12348, 'Marco', 'Neri');


# Eliminazione record DELETE FROM
Il comando SQL **`DELETE FROM`** viene utilizzato per **rimuovere record** (righe) da una tabella in un database. La sintassi consente di specificare quali record devono essere eliminati utilizzando una condizione.x
## Sintassi di base
```sql
DELETE FROM <nome_tabella> WHERE <condizione>;
```

>[!example] Example (Rimozione record specifico)
>Eliminazione dello studente con `MATR` pari a 12345:
>```sql
>DELETE FROM STUDENTI WHERE MATR = 12345;

>[!example] Example (Rimozione piu record)
>Eliminazione di tutti gli studenti il cui cognome Ã¨ "Rossi":
>```sql
>DELETE FROM STUDENTI WHERE COGNOME = 'Rossi';

>[!example]
>Rimozione dell'ultima bocciatura di "PP48":
>```sql
>DELETE FROM ESAMI
>WHERE MATR_STUD = 'PP48'
>AND DATA = (
>	SELECT MAX(DATA)
>	FROM ESAMI
>	WHERE VOTO = 17
>	AND MATR_STUD = 'PP48'
>);
>```

# Aggiornamento record di una tabella SET
Utilizzata per **aggiornare** i record in una tabella.
## Sintassi di base
```sql
UPDATE <nome_tabella>
SET <ATTR1> = <ESPR>
WHERE <condizione>;
```

>[!example]
>Aggiornare il voto di Mario Rossi a 21:
>```sql
>UPDATE STUDENTI 
>SET VOTO = 21 
>WHERE MATR = 12345;
>```
# Esercizio
![[schemaER-vettura-persona-polizza.svg#invert_B]]
- **VETTURE** (*ID*, ID_PERS, TARGA, MODELLO, CV_FIS)
- **PERSONE** (*ID*, COD_FIS, NOME, INDIRIZZO)
- **POLIZZE** (*NUMERO*, ID_PERS, ID_VETTURA, DATA, RISCHIO,PREMIO)
## Q1: Le vetture possedute da 'POLETTI' assicurate per RISCHIO = 'FURTO'
![[schema-vetture-persone-polizze-Q1.svg#invert_B]]
```sql
SELECT DISTINICT V.TARGA, V.MODELLO
FROM VETTURE V, PERSONE PE, POLIZZE PO
WHERE PE.NOME = 'PAOLETTI'
	AND PO.RISCHIO = 'FURTO'
	AND V.ID_PERS = PE.ID
	AND PO.ID_VETTURA = V.ID;
```